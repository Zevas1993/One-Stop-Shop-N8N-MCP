const http = require('http');

const API_KEY = process.env.N8N_API_KEY;
const WORKFLOW_ID = 'Baf9nylVDD1pzj9Q';

function makeRequest(path, method, data) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'localhost',
      port: 5678,
      path,
      method,
      headers: {
        'X-N8N-API-KEY': API_KEY,
        'Content-Type': 'application/json'
      }
    };

    const req = http.request(options, (res) => {
      let body = '';
      res.on('data', (chunk) => body += chunk);
      res.on('end', () => {
        try {
          resolve(JSON.parse(body));
        } catch (e) {
          resolve(body);
        }
      });
    });

    req.on('error', reject);
    if (data) req.write(JSON.stringify(data));
    req.end();
  });
}

async function fixWorkflow() {
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('FIXING BROKEN WORKFLOW - REMOVE EMPTY CREDENTIALS FIELD');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  // Fetch current workflow
  const workflow = await makeRequest(`/api/v1/workflows/${WORKFLOW_ID}`, 'GET');

  console.log('Current workflow nodes:');
  workflow.nodes.forEach((node, i) => {
    const hasEmptyCreds = node.credentials && Object.keys(node.credentials).length === 0;
    const hasWebhookId = 'webhookId' in node;
    console.log(`${i+1}. ${node.name}`);
    console.log(`   Type: ${node.type}`);
    if (hasEmptyCreds) console.log(`   ‚ùå Has empty credentials: {}` );
    if (hasWebhookId) console.log(`   ‚úÖ Has webhookId: ${node.webhookId}`);
  });

  // Fix: Remove empty credentials field from all nodes
  console.log('\nüîß Removing empty credentials fields...\n');

  workflow.nodes = workflow.nodes.map(node => {
    const fixed = { ...node };

    // Remove empty credentials object
    if (fixed.credentials && Object.keys(fixed.credentials).length === 0) {
      delete fixed.credentials;
      console.log(`‚úÖ Removed empty credentials from: ${node.name}`);
    }

    return fixed;
  });

  // Remove ALL read-only/system-managed fields (matching cleanWorkflowForUpdate)
  delete workflow.id;
  delete workflow.createdAt;
  delete workflow.updatedAt;
  delete workflow.versionId;
  delete workflow.meta;
  delete workflow.tags;
  delete workflow.isArchived;
  delete workflow.usedCredentials;
  delete workflow.sharedWithProjects;
  delete workflow.triggerCount;
  delete workflow.shared;
  delete workflow.active; // Managed via separate activation endpoint

  // Remove webhookId from webhook nodes (it's regenerated by n8n)
  workflow.nodes = workflow.nodes.map(node => {
    if (node.webhookId) {
      const fixed = { ...node };
      delete fixed.webhookId;
      return fixed;
    }
    return node;
  });

  console.log('\nüì§ Updating workflow via n8n API...\n');

  // Update workflow
  const result = await makeRequest(`/api/v1/workflows/${WORKFLOW_ID}`, 'PUT', workflow);

  if (result.id) {
    console.log('‚úÖ SUCCESS! Workflow updated');
    console.log(`   ID: ${result.id}`);
    console.log(`   Name: ${result.name}`);
    console.log(`   Version: ${result.versionId}`);
    console.log('\nüéØ Now try loading the workflow in n8n UI');
    console.log('   Hard refresh browser: Ctrl+Shift+R');
  } else {
    console.error('‚ùå FAILED to update workflow');
    console.error(result);
  }
}

fixWorkflow().catch(console.error);
